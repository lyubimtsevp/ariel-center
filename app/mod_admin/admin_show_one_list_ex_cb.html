<style>
	.mfrm input[type=text]{
		width:150px;
	}
	.mfrm select{
		width:180px;
		position: relative;
		top: 5px;
		border: 1px solid #ccc;
		box-shadow: inset 0 1px 1px rgba(0,0,0,0.075);
	}
	.mfrm label{
		display: inline-block;
		margin-right: 16px;
		font-weight: normal;
		margin-bottom: 10px;
	}
	.mfrm label input[type=checkbox]{
		position: relative;
		top:-1px;
		margin-right: 1px;
	}
</style>

<?
$query = '';
if(url(3)=='ex_cashbacks'){
    d()->objectrow = d()->User->where('type="ur" AND uid!=1 AND is_active=1')->order_by('sort desc');
    if(!$_GET){
		d()->ob_cnt = '('.d()->objectrow->count.')';
	}else{
		$c = 0;
		foreach($_GET as $k=>$v){
			if($k=='page' || $k=='date1' || $k=='date2' || $k=='run' || $k=='status') continue;
            if($c) $query .= 'AND ';
            if($k=='title'){
                $query .= '`'.$k.'` LIKE "%'.$v.'%" ';
            }else{
                $query .= '`'.$k.'` = "'.$v.'" ';
            }
			$c++;
		}
		if($c){
            d()->objectrow = d()->User->where($query);
        }
        d()->ob_cnt = '('.d()->objectrow->count.')';
    }
}
?>
@if($_GET['status'])d()->curr_title = 'Начисленный CashBack';
<h1>{curr_title} {ob_cnt}</h1>

{curr_content}

@if($_GET['run']=='success'):
<div class="alert alert-success">Операция выполнена успешно</div>
@endif;

<?if(url(3)=='ex_cashbacks'):?>
<form method="GET" style="margin-top:25px;" class="mfrm">

    <select id="status" style="width:200px;">
        <option value="0" <?if(!$_GET['status'])print 'selected';?>>Ожидаемый CashBack</option>
        <option value="1" <?if($_GET['status']==1)print 'selected';?>>Начисленный CashBack</option>
    </select>
    <input type="hidden" name="status" value="<?print $_GET['status']?>" />

    <span style="display: inline-block;margin:0 10px;"></span>

	<input type="text" id="uid" placeholder="ID юр. лица" class="form-control" value="<?print $_GET['uid']?>" style="margin-bottom:0;" />
	<input type="hidden" name="uid" value="<?print $_GET['uid']?>" />

    <input type="text" id="title" placeholder="Название юр. лица" class="form-control" value="<?print $_GET['title']?>" style="margin-bottom:0;" />
    <input type="hidden" name="title" value="<?print $_GET['title']?>" />

    <span style="display: inline-block;margin:0 10px;"></span>

    <input type="text" id="date1" placeholder="Период от" class="form-control admin_date" value="<?print $_GET['date1']?>" style="margin-bottom:0;width:90px;" autocomplete="off" />
    <input type="hidden" name="date1" value="<?print $_GET['date1']?>" />

    <span style="display: inline-block;margin:0 5px;">-</span>

    <input type="text" id="date2" placeholder="Период до" class="form-control admin_date" value="<?print $_GET['date2']?>" style="margin-bottom:0;width:90px;" autocomplete="off" />
    <input type="hidden" name="date2" value="<?print $_GET['date2']?>" />

    <span style="display: inline-block;margin:0 10px;"></span>

	<button class="btn btn-primary">Найти</button>
	<a href="/admin/list/ex_cashbacks/" class="btn btn-default">Сбросить</a>
</form>
<hr style="margin:15px 0;">
<?endif;?>

<?
    $packs = d()->Package->to_array();
    foreach($packs as $val)$p[$val['id']] = $val;
?>

<table class="table table-striped table-bordered table-condensed"  width="100%">
    <thead>
        <tr>
            <th width=50>ID</th>
            <th>Название</th>
            <th>CashBack</th>
            <th>Оборот</th>
            <th>Общий CashBack</th>
            <th>Личный CashBack</th>
            <th>CashBack по линиям</th>
            <th>Агентский бонус</th>
            <th>Наш CashBack</th>
            <th></th>
        </tr>
    </thead>
	<foreach objectrow>
	<tr>
        <!--выбираем операции в указанный период и подсчитываем инфу-->
        <?php
        $q = '`type`="ur_payment" AND `le_user_id`="'.d()->this->uid.'"';
        if(empty($_GET['status'])){
            $q .= 'AND `status`="0"';
        }
        foreach($_GET as $k=>$v){
            if($k=='page' || $k=='uid' || $k=='title' || $k=='run') continue;
            $q .= ' AND ';
            if($k=='date1'){
                $d = date('Y-m-d', strtotime($_GET['date1']));
                $q .= '`created_at` >= "'.$d.'" ';
            }elseif($k=='date2'){
                $d = date('Y-m-d H:i:s', strtotime($_GET['date2'])+86399);
                $q .= '`created_at` <= "'.$d.'" ';
            }else{
                $q .= '`'.$k.'` = "'.$v.'" ';
            }
        }
        $o = d()->Operation->where($q);


        d()->oborot = 0;
        d()->o_cb = 0;
        d()->l_cb = 0;
        d()->lines_cb = 0;
        d()->a1_cb = 0;
        d()->a2_cb = 0;
        foreach($o as $v){
            // выбираем пользователя
            $u = d()->User->where('uid=?', $o->uid)->limit(0,1);
            $l_cb_p = $p[$u->package]['cashback'];
            // считаем ожидаемый КБ по линиям
            $uids = explode(',',$o->text);
            $sv_users = d()->Sv_user->where('uid=?', $o->uid)->to_array();
            $sv = Array();
            foreach($sv_users as $k=>$v){
                $sv[$v['sponsor']] = $v['type'];
            }
            foreach($uids as $v){
                // расчитываем
                $us = d()->User->where('uid=?', $v)->limit(0,1);
                // если отсутствует пользователь
                if(!count($us)){
                    continue;
                }
                $line = $sv[$v];
                $cf = $p[$us->package]['cashback_l'.$line];
                d()->lines_cb += d()->truncated($o->value/100*$cf);
            }

            // агентский КБ, если есть кому
            $ag_sv_users = d()->Sv_user->where('uid=?', $o->le_user_id)->to_array();
            $le_user = d()->User->where('uid=?',$o->le_user_id)->limit(0,1);
            foreach($ag_sv_users as $k=>$v){
                $ag_user = d()->User->where('uid=?', $v['sponsor'])->limit(0,1);
                // есть ли пользователь
                if(!count($ag_user)){
                    continue;
                }
                // позволяет ли ему пакет
                if($v['type']==1){
                    if($p[$ag_user->package]['bonus_agent']>0){
                        $value_p = $p[$ag_user->package]['bonus_agent'];
                        // расчитываем бонус
                        d()->a1_cb += d()->truncated($o->value/100*$value_p);
                        d()->a1_uid = $ag_user->uid;
                    }else{
                        continue;
                    }
                }
                if($v['type']==2){
                    if($p[$ag_user->package]['bonus_dopagent']>0){
                        $value_p = $p[$ag_user->package]['bonus_dopagent'];
                        // расчитываем бонус
                        d()->a2_cb += d()->truncated($o->value/100*$value_p);
                        d()->a2_uid = $ag_user->uid;
                    }else{
                        continue;
                    }
                }
            }

            d()->oborot += $o->amount;
            d()->o_cb += $o->value;
            // формулы должны совпадать с формулами из save_operations
            d()->l_cb += d()->truncated($o->value/100*$l_cb_p);
        }
        // наш кешбэк
        d()->n_cb = d()->o_cb - d()->l_cb - d()->lines_cb - d()->a1_cb - d()->a2_cb;
        ?>
		<td>{.uid}</td>
        <td>{.title}</td>
        <!--процент кешбека-->
        <?php
            d()->cb = '';
            $cb = array_filter(explode('|',d()->this->cashback));
            foreach($cb as $v) d()->cb .= $v.'%, ';
            d()->cb = substr(trim(d()->cb),0,-1);
        ?>
        <td>{cb}</td>
        <!--оборот-->
        <td>{oborot} руб.</td>
        <!--общий кб-->
        <td>{o_cb} руб.</td>
        <!--личный кб-->
        <td>{l_cb} руб.</td>
        <!--кб по линиям-->
        <td>{lines_cb} руб.</td>
        <!--агентский кб-->
        <td>
            ID {a1_uid}: {a1_cb} руб.
            @if(d()->a2_uid):
            <br>ID {a2_uid}: {a2_cb} руб.
            @endif;
        </td>
        <!--наш кб-->
        <td>{n_cb} руб.</td>
        <!--начисление кб-->
        <?$key = hash('md5','ti%^rex'.d()->Option->admin_key.'p@anz0#er');?>
        <td>
            @if(d()->o_cb && !$_GET['status']):
            <a href="/run_ex_cashback?uid={.uid}&key=<?=$key?>&date1=<?=$_GET['date1'];?>&date2=<?=$_GET['date2'];?>&title=<?=$_GET['title'];?>&id=<?=$_GET['uid'];?>" class="btn btn-mini btn-success" onclick="$('#load-{.uid}').show();$(this).hide()">НАЧИСЛИТЬ</a>
            <img src="/images/loading2.gif" width="20px" style="display: none;" id="load-{.uid}" />
            @else:
            <button class="btn btn-mini btn-success" disabled>НАЧИСЛИТЬ</button>
            @endif;
        </td>

	</tr>
	</foreach>

</table>


<script>
    $('form').submit(function(event){
        var inputs = $(this).find('input');
        $(inputs).each(function(index){
            var id = $(this).attr('id');
            var val = $(this).val();
            if(id){
                var inp = $('input[name="'+id+'"]');
                if(val){
                    inp.val(val);
                }else{
                    inp.prop('disabled', true);
                }
            }
        });

        var selects = $(this).find('select');
        $(selects).each(function(index){
            var id = $(this).attr('id');
            var val = $(this).val();
            if(id){
                var inp = $('input[name="'+id+'"]');
                if(val){
                    inp.val(val);
                }else{
                    inp.prop('disabled', true);
                }
            }
        });

        if(!$('input[name="category_id"]').val()){
            $('input[name="category_id"]').prop('disabled', true);
        }
    });
</script>
